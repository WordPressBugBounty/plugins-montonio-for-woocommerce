(()=>{"use strict";const e=window.React,o=window.wp.element,n=window.wp.data,t=window.wp.i18n,{registerPaymentMethod:r}=wc.wcBlocksRegistry,{getSetting:a}=wc.wcSettings,{decodeEntities:c}=wp.htmlEntities,{applyFilters:i,addFilter:s}=wp.hooks,{MontonioCheckout:m}=window.Montonio,l=a("wc_montonio_card_data",{}),d=i("wc_montonio_card_block_title",c(l.title||(0,t.__)("Card Payment","montonio-for-woocommerce")),l);s("wc_montonio_card_block_description","montonio-for-woocommerce",((e,o)=>("yes"===o.sandboxMode&&(e="<strong>"+(0,t.__)("TEST MODE ENABLED!","montonio-for-woocommerce")+"</strong><br>"+(0,t.__)("When test mode is enabled, payment providers do not process payments.","montonio-for-woocommerce")+"<br>"+e),e)));const u=i("wc_montonio_card_block_description",c(l.description),l),w=n=>(0,e.createElement)(o.RawHTML,null,n),p=({setMontonioCheckout:n})=>{const[t,r]=(0,o.useState)(!1),[a,c]=(0,o.useState)(!1),[i,s]=(0,o.useState)(null),d=(0,o.useCallback)((async()=>{r(!0),s(null);const e=new FormData;e.append("action","get_session_uuid"),e.append("sandbox_mode",l.sandboxMode),e.append("nonce",l.nonce);try{const o=await fetch(woocommerce_params.ajax_url,{method:"POST",credentials:"same-origin",body:e}),n=await o.json();if(!n.success||!n.data.uuid)throw new Error(n.data||"Failed to initialize payment");window.cardPaymentSessionUuid=n.data,await u(),c(!0)}catch(e){console.error("Error initializing payment:",e),s(e.message||"Failed to initialize payment")}finally{r(!1)}}),[]),u=async()=>{try{if("undefined"==typeof Montonio)throw new Error("Montonio SDK is not loaded");const e=new m({sessionUuid:window.cardPaymentSessionUuid.uuid,environment:"yes"===l.sandboxMode?"sandbox":"production",locale:l.locale});await e.initialize("#montonio-card-form"),n(e)}catch(e){console.error(e)}};return(0,o.useEffect)((()=>{a||d()}),[a,d]),(0,e.createElement)("div",{id:"montonio-card-form-wrapper",className:t?"loading":""},t&&(0,e.createElement)("div",{className:"montonio-spinner montonio-spinner--centered"}),i&&(0,e.createElement)("div",{className:"montonio-error"},i),(0,e.createElement)("div",{id:"montonio-card-form"}))},y=({eventRegistration:r})=>{if("yes"!==l.inlineCheckout)return u?(0,e.createElement)("p",{className:"montonio-payment-block-description"},w(u)):null;const{onPaymentSetup:a,onCheckoutSuccess:c,onCheckoutFail:i}=r,[s,m]=(0,o.useState)(null),{createErrorNotice:d,removeNotice:y}=(0,n.useDispatch)("core/notices"),_=document.getElementById("montonio-card-form");return(0,o.useEffect)((()=>{const e=a((async()=>{if(y("wc-montonio-card-error","wc/checkout"),_&&""!==_.innerHTML.trim()){try{await s.validateOrReject()}catch(e){return{type:"error",message:e.message||(0,t.__)("An error occurred during payment processing. Please try again.","montonio-for-woocommerce")}}return{type:"success",meta:{paymentMethodData:{montonio_card_payment_session_uuid:window.cardPaymentSessionUuid?.uuid||""}}}}})),o=c((async e=>{try{return{type:"success",redirectUrl:(await s.submitPayment()).returnUrl}}catch(e){console.error("Payment submission error:",e);const o=e.message||(0,t.__)("An error occurred during payment processing. Please try again.","montonio-for-woocommerce");return d(o,{context:"wc/checkout"}),{type:"error",message:o,retry:!0}}})),n=i((e=>{console.error("Checkout failed:",e);const{processingResponse:o}=e,n=o.paymentDetails?.message;return{type:"error",message:n,retry:!0,messageContext:"wc/checkout"}}));return()=>{e(),o(),n()}}),[a,c,i,s,d,y]),(0,e.createElement)(e.Fragment,null,u&&(0,e.createElement)("p",{className:"montonio-payment-block-description"},w(u)),(0,e.createElement)(p,{setMontonioCheckout:m}))},_=()=>(0,e.createElement)("span",null,(0,e.createElement)("img",{src:l.iconurl,alt:"Montonio Card"}));r({name:"wc_montonio_card",label:(0,e.createElement)((()=>(0,e.createElement)("span",null,d,(0,e.createElement)(_,null))),null),content:(0,e.createElement)(y,null),edit:(0,e.createElement)(y,null),canMakePayment:()=>i("wc_montonio_card_block_enabled",!0,l),ariaLabel:d})})();
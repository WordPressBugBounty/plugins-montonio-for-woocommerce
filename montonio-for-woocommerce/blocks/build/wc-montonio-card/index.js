(()=>{"use strict";const e=window.React,o=window.wp.element,n=window.wp.data,t=window.wp.i18n,{registerPaymentMethod:r}=wc.wcBlocksRegistry,{getSetting:a}=wc.wcSettings,{decodeEntities:i}=wp.htmlEntities,{applyFilters:c,addFilter:s}=wp.hooks,{MontonioCheckout:m}=window.Montonio,d=a("wc_montonio_card_data",{}),l=c("wc_montonio_card_block_title",i(d.title||(0,t.__)("Card Payment","montonio-for-woocommerce")),d);s("wc_montonio_card_block_description","montonio-for-woocommerce",((e,o)=>(o.sandboxMode&&(e="<strong>"+(0,t.__)("TEST MODE ENABLED!","montonio-for-woocommerce")+"</strong><br>"+(0,t.__)("When test mode is enabled, payment providers do not process payments.","montonio-for-woocommerce")+"<br>"+e),e)));const u=c("wc_montonio_card_block_description",i(d.description),d),w=n=>(0,e.createElement)(o.RawHTML,null,n),p=({setMontonioCheckout:n})=>{const[t,r]=(0,o.useState)(!1),[a,i]=(0,o.useState)(!1),[c,s]=(0,o.useState)(null),l=(0,o.useCallback)((async()=>{r(!0),s(null);const e=new FormData;e.append("action","get_session_uuid"),e.append("nonce",d.nonce);try{const o=await fetch(woocommerce_params.ajax_url,{method:"POST",credentials:"same-origin",body:e}),n=await o.json();if(!n.success||!n.data.uuid)throw new Error(n.data||"Failed to initialize payment");window.cardPaymentSessionUuid=n.data,await u(),i(!0)}catch(e){console.error("Error initializing payment:",e),s(e.message||"Failed to initialize payment")}finally{r(!1)}}),[]),u=async()=>{try{if("undefined"==typeof Montonio)throw new Error("Montonio SDK is not loaded");const e=new m({sessionUuid:window.cardPaymentSessionUuid.uuid,environment:d.sandboxMode?"sandbox":"production",locale:d.locale,onSuccess:e=>{window.dispatchEvent(new CustomEvent("montonioPaymentSuccess",{detail:e}))},onError:e=>{window.dispatchEvent(new CustomEvent("montonioPaymentError",{detail:e}))},onActionRequired:()=>{const e=document.getElementById("montonio-card-form");e&&e.scrollIntoView({behavior:"smooth",block:"start"})}});await e.initialize("#montonio-card-form"),n(e)}catch(e){console.error(e)}};return(0,o.useEffect)((()=>{a||l()}),[a,l]),(0,e.createElement)("div",{id:"montonio-card-form-wrapper",className:t?"loading":""},t&&(0,e.createElement)("div",{className:"montonio-spinner montonio-spinner--centered"}),c&&(0,e.createElement)("div",{className:"montonio-error"},c),(0,e.createElement)("div",{id:"montonio-card-form"}))},y=({eventRegistration:r})=>{if("yes"!==d.inlineCheckout)return u?(0,e.createElement)("p",{className:"montonio-payment-block-description"},w(u)):null;const{onPaymentSetup:a,onCheckoutSuccess:i,onCheckoutFail:c}=r,[s,m]=(0,o.useState)(null),{createErrorNotice:l,removeNotice:y}=(0,n.useDispatch)("core/notices"),E=document.getElementById("montonio-card-form");return(0,o.useEffect)((()=>{const e=a((()=>{if(y("wc-montonio-card-error","wc/checkout"),E&&""!==E.innerHTML.trim()){try{s.validateOrReject()}catch(e){return{type:"error",message:e.message||(0,t.__)("Please check your payment details and try again. Please try again.","montonio-for-woocommerce")}}return{type:"success",meta:{paymentMethodData:{montonio_card_payment_session_uuid:window.cardPaymentSessionUuid?.uuid||""}}}}})),o=i((e=>new Promise((e=>{const o=o=>{r(),e({type:"success",redirectUrl:o.detail.returnUrl})},n=o=>{r();const n=o.detail.message||(0,t.__)("Payment could not be completed. Please try again or choose a different payment method.","montonio-for-woocommerce");l(n,{context:"wc/checkout"}),e({type:"error",message:n,retry:!0})},r=()=>{window.removeEventListener("montonioPaymentSuccess",o),window.removeEventListener("montonioPaymentError",n)};window.addEventListener("montonioPaymentSuccess",o),window.addEventListener("montonioPaymentError",n),s.submitPayment()})))),n=c((e=>{console.error("Checkout failed:",e);const{processingResponse:o}=e,n=o.paymentDetails?.message;return{type:"error",message:n,retry:!0,messageContext:"wc/checkout"}}));return()=>{e(),o(),n()}}),[a,i,c,s,l,y]),(0,e.createElement)(e.Fragment,null,u&&(0,e.createElement)("p",{className:"montonio-payment-block-description"},w(u)),(0,e.createElement)(p,{setMontonioCheckout:m}))},E=()=>(0,e.createElement)("span",null,(0,e.createElement)("img",{src:d.iconurl,alt:"Montonio Card"}));r({name:"wc_montonio_card",label:(0,e.createElement)((()=>(0,e.createElement)("span",null,l,(0,e.createElement)(E,null))),null),content:(0,e.createElement)(y,null),edit:(0,e.createElement)(y,null),canMakePayment:()=>c("wc_montonio_card_block_enabled",!0,d),ariaLabel:l})})();
(()=>{"use strict";const e=window.React,t=window.wp.element,n=window.wp.data,o=window.wp.i18n,{registerPaymentMethod:a}=wc.wcBlocksRegistry,{getSetting:r}=wc.wcSettings,{decodeEntities:c}=wp.htmlEntities,{applyFilters:i,addFilter:m}=wp.hooks,s=r("wc_montonio_card_data",{}),l=i("wc_montonio_card_block_title",c(s.title||(0,o.__)("Card Payment","montonio-for-woocommerce")),s);m("wc_montonio_card_block_description","montonio-for-woocommerce",((e,t)=>(t.sandboxMode&&(e="<strong>"+(0,o.__)("TEST MODE ENABLED!","montonio-for-woocommerce")+"</strong><br>"+(0,o.__)("When test mode is enabled, payment providers do not process payments.","montonio-for-woocommerce")+"<br>"+e),e)));const d=i("wc_montonio_card_block_description",c(s.description),s),u=n=>(0,e.createElement)(t.RawHTML,null,n),w=({setIsFormCompleted:a,setEmbeddedPayment:r})=>{const[c,i]=(0,t.useState)(!1),[m,l]=(0,t.useState)(!1),[d,u]=(0,t.useState)(null),w=(0,n.useSelect)((e=>{const t=e("wc/store/cart").getCustomerData();return t.billingAddress.country||t.shippingAddress.country})),y=(0,t.useCallback)((async()=>{if(i(!0),u(null),window.cardPaymentsIntentData)return await p(),l(!0),void i(!1);const e=new FormData;e.append("action","get_payment_intent"),e.append("method","cardPayments"),e.append("nonce",s.nonce);try{const t=await fetch(woocommerce_params.ajax_url,{method:"POST",credentials:"same-origin",body:e}),n=await t.json();if(!n.success)throw new Error(n.data||"Failed to initialize payment");window.cardPaymentsIntentData=n.data,await p(),l(!0)}catch(e){console.error("Error initializing payment:",e),u(e.message||"Failed to initialize payment")}finally{i(!1)}}),[]),p=async()=>{try{if("undefined"==typeof MontonioLegacy||void 0===MontonioLegacy.Checkout)throw new Error("Montonio SDK is not loaded");const e=await MontonioLegacy.Checkout.EmbeddedPayments.initializePayment({stripePublicKey:window.cardPaymentsIntentData.stripePublicKey,stripeClientSecret:window.cardPaymentsIntentData.stripeClientSecret,paymentIntentUuid:window.cardPaymentsIntentData.uuid,locale:s.locale||"en",country:w||"EE",targetId:"montonio-card-form"});e.on("change",(e=>{a(e.isCompleted)})),r(e)}catch(e){console.error("Error in initializePayment:",e)}};return(0,t.useEffect)((()=>{m||y()}),[m,y]),(0,e.createElement)("div",{id:"montonio-card-form-wrapper",className:c?"loading":"",style:c?{opacity:.6}:{}},c&&(0,e.createElement)("div",{className:"montonio-loader"},(0,o.__)("Loading...","montonio-for-woocommerce")),d&&(0,e.createElement)("div",{className:"montonio-error"},d),(0,e.createElement)("div",{id:"montonio-card-form"}))},y=({eventRegistration:a})=>{if("yes"!==s.inlineCheckout)return d?(0,e.createElement)("p",{className:"montonio-payment-block-description"},u(d)):null;const{onPaymentSetup:r,onCheckoutSuccess:c}=a,[i,m]=(0,t.useState)(!1),[l,y]=(0,t.useState)(null),{createErrorNotice:p,removeNotice:_}=(0,n.useDispatch)("core/notices"),E=document.getElementById("montonio-card-form"),[g,f]=(0,t.useState)(!1);return(0,t.useEffect)((()=>{const e=r((()=>(_("wc-montonio-card-error","wc/checkout"),!E||""===E.innerHTML.trim()||i?{type:"success",meta:{paymentMethodData:{montonio_card_payment_intent_uuid:window.cardPaymentsIntentData?.uuid||""}}}:{type:"error",message:(0,o.__)("Please fill in the required fields for the payment method.","montonio-for-woocommerce")}))),t=c((async e=>{if(E&&""!==E.innerHTML.trim())try{return{type:"success",redirectUrl:(await l.confirmPayment(s.sandboxMode)).returnUrl}}catch(e){console.log(e.message);const t=e.message||(0,o.__)("An error occurred during payment processing. Please try again.","montonio-for-woocommerce");return p(t,{context:"wc/checkout"}),window.cardPaymentsIntentData=null,f((e=>!e)),{type:"error",message:t,retry:!0}}}));return()=>{e(),t()}}),[r,c,i,l,p,_]),(0,e.createElement)(e.Fragment,null,d&&(0,e.createElement)("p",{className:"montonio-payment-block-description"},u(d)),(0,e.createElement)(w,{setIsFormCompleted:m,setEmbeddedPayment:y,key:g}))},p=()=>(0,e.createElement)("span",null,(0,e.createElement)("img",{src:s.iconurl,alt:"Montonio Card"}));a({name:"wc_montonio_card",label:(0,e.createElement)((()=>(0,e.createElement)("span",null,l,(0,e.createElement)(p,null))),null),content:(0,e.createElement)(y,null),edit:(0,e.createElement)(y,null),canMakePayment:()=>i("wc_montonio_card_block_enabled",!0,s),ariaLabel:l})})();